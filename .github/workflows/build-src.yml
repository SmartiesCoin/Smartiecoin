name: Build source

on:
  workflow_call:
    inputs:
      build-target:
        description: "Target name as defined by inputs.sh"
        required: true
        type: string
      container-path:
        description: "Path to built container at registry"
        required: true
        type: string
      depends-key:
        description: "Key needed to access cached depends"
        required: true
        type: string
      depends-host:
        description: "Host triplet from depends build"
        required: true
        type: string
      depends-dep-opts:
        description: "DEP_OPTS used to build depends"
        required: false
        type: string
        default: ""
      runs-on:
        description: "Runner label to use (e.g., ubuntu-24.04 or ubuntu-24.04-arm)"
        required: false
        default: ubuntu-24.04
        type: string
    outputs:
      key:
        description: "Key needed for restoring artifacts bundle"
        value: ${{ jobs.build-src.outputs.key }}

jobs:
  build-src:
    name: Build source
    runs-on: ${{ inputs.runs-on }}
    outputs:
      key:  ${{ steps.bundle.outputs.key }}
    container:
      image: ${{ inputs.container-path }}
      options: --user root
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 50

      - name: Initial setup
        id: setup
        run: |
          git config --global --add safe.directory "$PWD"
          git fetch -fu origin develop:develop
          BUILD_TARGET="${{ inputs.build-target }}"
          source ./ci/smartiecoin/matrix.sh
          echo "HOST=${HOST}" >> $GITHUB_OUTPUT
          echo "PR_BASE_SHA=${{ github.event.pull_request.base.sha || '' }}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Restore SDKs cache
        uses: actions/cache/restore@v4
        if: inputs.build-target == 'mac'
        with:
          path: |
            depends/SDKs
          key: depends-sdks-${{ hashFiles('depends/hosts/darwin.mk') }}
          fail-on-cache-miss: true

      - name: Restore depends cache
        uses: actions/cache/restore@v4
        with:
          path: depends/built/${{ inputs.depends-host }}
          key: ${{ inputs.depends-key }}
          fail-on-cache-miss: true

      - name: Rebuild depends prefix
        run: |
          # Use the HOST and DEP_OPTS from the depends build, not this build-target
          # This ensures the build_id matches the cached packages
          make -j$(nproc) -C depends HOST="${{ inputs.depends-host }}" ${{ inputs.depends-dep-opts }}
        shell: bash

      - name: Restore ccache cache
        uses: actions/cache/restore@v4
        with:
          path: |
            /cache/ccache
          key: ccache-${{ hashFiles('contrib/containers/ci/ci.Dockerfile', 'depends/packages/*') }}-${{ inputs.build-target }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ hashFiles('contrib/containers/ci/ci.Dockerfile', 'depends/packages/*') }}-${{ inputs.build-target }}-

      - name: Build source
        run: |
          CCACHE_MAXSIZE="600M"
          CACHE_DIR="/cache"
          mkdir /output
          BASE_OUTDIR="/output"
          BUILD_TARGET="${{ inputs.build-target }}"
          source ./ci/smartiecoin/matrix.sh
          ./ci/smartiecoin/build_src.sh
          ccache -X 9
          ccache -c
          du -hd0 "${BASE_OUTDIR}"
          rm -rf "${BASE_OUTDIR}"
        shell: bash

      - name: Save ccache cache
        if: |
          github.event_name == 'push' &&
          github.ref_name == github.event.repository.default_branch
        uses: actions/cache/save@v4
        with:
          path: |
            /cache/ccache
          key: ccache-${{ hashFiles('contrib/containers/ci/ci.Dockerfile', 'depends/packages/*') }}-${{ inputs.build-target }}-${{ github.sha }}

      - name: Restore ctcache cache
        if: inputs.build-target == 'linux64_multiprocess'
        uses: actions/cache/restore@v4
        with:
          path: |
            /cache/ctcache
          key: ctcache-${{ hashFiles('contrib/containers/ci/ci.Dockerfile', 'depends/packages/*') }}-${{ inputs.build-target }}-${{ github.sha }}
          restore-keys: |
            ctcache-${{ hashFiles('contrib/containers/ci/ci.Dockerfile', 'depends/packages/*') }}-${{ inputs.build-target }}-

      - name: Run linters
        if: inputs.build-target == 'linux64_multiprocess'
        run: |
          CACHE_DIR="/cache"
          export BUILD_TARGET="${{ inputs.build-target }}"
          source ./ci/smartiecoin/matrix.sh
          ./ci/smartiecoin/lint-tidy.sh
        shell: bash

      - name: Save ctcache cache
        if: |
          inputs.build-target == 'linux64_multiprocess' &&
          github.event_name == 'push' &&
          github.ref_name == github.event.repository.default_branch
        uses: actions/cache/save@v4
        with:
          path: |
            /cache/ctcache
          key: ctcache-${{ hashFiles('contrib/containers/ci/ci.Dockerfile', 'depends/packages/*') }}-${{ inputs.build-target }}-${{ github.sha }}

      - name: Run unit tests
        run: |
          BUILD_TARGET="${{ inputs.build-target }}"
          source ./ci/smartiecoin/matrix.sh
          ./ci/smartiecoin/test_unittests.sh
        shell: bash

      - name: Bundle artifacts
        id: bundle
        run: |
          export BUILD_TARGET="${{ inputs.build-target }}"
          export BUNDLE_KEY="build-${BUILD_TARGET}-$(git rev-parse --short=8 HEAD)"
          find "build-ci/dashcore-${BUILD_TARGET}/src/" -name "*.a" -type f -delete
          find "build-ci/dashcore-${BUILD_TARGET}/src/" -name "*.o" -type f -delete
          ./ci/smartiecoin/bundle-artifacts.sh create
          echo "key=${BUNDLE_KEY}" >> "${GITHUB_OUTPUT}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.bundle.outputs.key }}
          path: |
            ${{ steps.bundle.outputs.key }}.tar.zst
          compression-level: 0
          overwrite: true
          retention-days: 3
